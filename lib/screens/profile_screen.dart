import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:go_router/go_router.dart';
import '../services/auth_service.dart';
import '../services/subscription_service.dart';
import '../services/localization_service.dart';
import '../utils/content_policy.dart';
import 'simple_auth_screen.dart';
import 'app_info_screen.dart';
import 'package:url_launcher/url_launcher.dart';

class ProfileScreen extends StatefulWidget {
  const ProfileScreen({super.key});

  @override
  State<ProfileScreen> createState() => _ProfileScreenState();
}

class _ProfileScreenState extends State<ProfileScreen> {
  final AuthService _authService = AuthService();
  late SubscriptionService _subscriptionService;
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _subscriptionService = SubscriptionService(_authService);
    _initializeSubscription();
    
    // AuthServiceÏùò ÏÉÅÌÉú Î≥ÄÌôî Í∞êÏßÄ
    _authService.addListener(_onAuthStateChanged);
  }
  
  @override
  void dispose() {
    _authService.removeListener(_onAuthStateChanged);
    _deleteConfirmController.dispose();
    super.dispose();
  }

  void _onAuthStateChanged() {
    if (mounted) {
      setState(() {}); // Ïù∏Ï¶ù ÏÉÅÌÉú Î≥ÄÌôî Ïãú UI ÏÉàÎ°úÍ≥†Ïπ®
    }
  }

  Future<void> _initializeSubscription() async {
    await _subscriptionService.initialize();
    if (mounted) setState(() {});
  }

  @override
  Widget build(BuildContext context) {
    final user = _authService.currentUser;
    final isGuest = user?.id == 'guest-user-id';

    return Consumer<LocalizationService>(
      builder: (context, localizationService, child) {
        final localizations = AppLocalizations(localizationService.currentLanguage);
        
        return Scaffold(
          appBar: AppBar(
            title: Text(
              localizations.profile,
              style: const TextStyle(
                fontWeight: FontWeight.bold,
                color: Color(0xFF1E293B),
              ),
            ),
            backgroundColor: Colors.transparent,
            elevation: 0,
            actions: [
              // Ïñ∏Ïñ¥ Ï†ÑÌôò Î≤ÑÌäº
              Container(
                margin: const EdgeInsets.only(right: 16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(20),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.1),
                      blurRadius: 6,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Material(
                  color: Colors.transparent,
                  child: InkWell(
                    onTap: () => localizationService.toggleLanguage(),
                    borderRadius: BorderRadius.circular(20),
                    child: Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Text(
                            localizationService.isKorean ? 'üá∞üá∑' : 'üá∫üá∏',
                            style: const TextStyle(fontSize: 16),
                          ),
                          const SizedBox(width: 4),
                          Text(
                            localizationService.isKorean ? 'KOR' : 'ENG',
                            style: const TextStyle(
                              fontSize: 12,
                              fontWeight: FontWeight.w600,
                              color: Color(0xFF6366F1),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.all(20.0),
          child: Column(
            children: [
              // ÌîÑÎ°úÌïÑ Ìó§Îçî
              Container(
                width: double.infinity,
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  gradient: const LinearGradient(
                    colors: [Color(0xFF6366F1), Color(0xFF8B5CF6)],
                  ),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Column(
                  children: [
                    CircleAvatar(
                      radius: 40,
                      backgroundColor: Colors.white.withOpacity(0.2),
                      child: Icon(
                        isGuest ? Icons.person_outline : Icons.person,
                        size: 40,
                        color: Colors.white,
                      ),
                    ),
                    const SizedBox(height: 16),
                    Text(
                      isGuest ? localizations.guestUser : (user?.email ?? localizations.user),
                      style: const TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: Text(
                        _subscriptionService.isPremium ? localizations.premiumMember : localizations.freeMember,
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                        ),
                      ),
                    ),
                  ],
                ),
              ),

              const SizedBox(height: 24),

              // Í≤åÏä§Ìä∏ Î™®ÎìúÏùº ÎïåÎßå Î°úÍ∑∏Ïù∏ Ïú†ÎèÑ
              if (isGuest) ...[
                _buildLoginPrompt(localizations),
                const SizedBox(height: 24),
              ],

              // Íµ¨ÎèÖ Í¥ÄÎ¶¨
              _buildSubscriptionSection(localizations),

              const SizedBox(height: 16),

              // Í≥ÑÏ†ï Í¥ÄÎ¶¨
              _buildAccountSection(isGuest, localizations),

              // ÏõπÏóêÏÑúÎßå Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú ÎßÅÌÅ¨ ÌëúÏãú
              if (kIsWeb) ...[
                const SizedBox(height: 16),
                _buildAdminSection(),
              ],

              const SizedBox(height: 24),

              // Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº (Í≤åÏä§Ìä∏Í∞Ä ÏïÑÎãê ÎïåÎßå)
              if (!isGuest)
                _buildLogoutButton(localizations),
            ],
          ),
        ),
      ),
        );
      },
    );
  }

  Widget _buildLoginPrompt(AppLocalizations localizations) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFFF0F9FF),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFF0EA5E9).withOpacity(0.2)),
      ),
      child: Column(
        children: [
          const Icon(
            Icons.cloud_sync_outlined,
            size: 40,
            color: Color(0xFF0EA5E9),
          ),
          const SizedBox(height: 12),
          Text(
            localizations.loginForSync,
            style: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: Color(0xFF1E293B),
            ),
          ),
          const SizedBox(height: 8),
          Text(
            localizations.loginSyncDesc,
            textAlign: TextAlign.center,
            style: const TextStyle(
              fontSize: 14,
              color: Color(0xFF64748B),
            ),
          ),
          const SizedBox(height: 16),
          SizedBox(
            width: double.infinity,
            height: 48,
            child: ElevatedButton(
              onPressed: () => _navigateToAuth(),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF0EA5E9),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
              ),
              child: Text(
                localizations.loginSignup,
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSubscriptionSection(AppLocalizations localizations) {
    final user = _authService.currentUser;
    final isGuest = user?.id == 'guest-user-id';
    
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'Íµ¨ÎèÖ Í¥ÄÎ¶¨',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: Color(0xFF1E293B),
            ),
          ),
          const SizedBox(height: 16),
          // Íµ¨ÎèÖ ÏÑúÎπÑÏä§ Ï§ÄÎπÑ Ï§ë ÌëúÏãú
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: const Color(0xFFFEF3C7),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(
                color: const Color(0xFFFCD34D),
                width: 1,
              ),
            ),
            child: Row(
              children: const [
                Icon(
                  Icons.construction,
                  color: Color(0xFFF59E0B),
                  size: 20,
                ),
                SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'Íµ¨ÎèÖ ÏÑúÎπÑÏä§ Ï§ÄÎπÑ Ï§ë',
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: Color(0xFF92400E),
                        ),
                      ),
                      SizedBox(height: 4),
                      Text(
                        'ÌòÑÏû¨ ÌïòÎ£® 10Ìöå Î¨¥Î£åÎ°ú Ïù¥Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§',
                        style: TextStyle(
                          fontSize: 12,
                          color: Color(0xFF92400E),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 12),
          _buildMenuTile(
            icon: Icons.star_outline,
            title: 'ÌîÑÎ¶¨ÎØ∏ÏóÑ Íµ¨ÎèÖ (Ï§ÄÎπÑ Ï§ë)',
            subtitle: 'Î¨¥Ï†úÌïú ÏùºÍ∏∞ ÏûëÏÑ±',
            onTap: () => context.push('/subscription'),
          ),
          // Í≤åÏä§Ìä∏Í∞Ä ÏïÑÎãê ÎïåÎßå Íµ¨Îß§ Î≥µÏõê Î≤ÑÌäº ÌëúÏãú
          if (!isGuest)
            _buildMenuTile(
              icon: Icons.restore,
              title: 'Íµ¨Îß§ Î≥µÏõê',
              subtitle: 'Ïù¥Ï†Ñ Íµ¨Îß§ ÎÇ¥Ïó≠ Î≥µÏõê',
              onTap: _restorePurchases,
            ),
        ],
      ),
    );
  }

  Widget _buildAccountSection(bool isGuest, AppLocalizations localizations) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'Í≥ÑÏ†ï Ï†ïÎ≥¥',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: Color(0xFF1E293B),
            ),
          ),
          const SizedBox(height: 16),
          _buildMenuTile(
            icon: Icons.info_outline,
            title: 'Ïï± Ï†ïÎ≥¥',
            subtitle: 'v1.0.0',
            onTap: () => _navigateToAppInfo(),
          ),
          _buildMenuTile(
            icon: Icons.privacy_tip_outlined,
            title: 'Í∞úÏù∏Ï†ïÎ≥¥Ï≤òÎ¶¨Î∞©Ïπ®',
            subtitle: 'Í∞úÏù∏Ï†ïÎ≥¥ Î≥¥Ìò∏ Ï†ïÏ±Ö',
            onTap: () => _openPrivacyPolicy(),
          ),
          _buildMenuTile(
            icon: Icons.description_outlined,
            title: 'Ïù¥Ïö©ÏïΩÍ¥Ä',
            subtitle: 'ÏÑúÎπÑÏä§ Ïù¥Ïö©ÏïΩÍ¥Ä',
            onTap: () => _openTermsOfService(),
          ),
          // Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏòµÏÖò Ï∂îÍ∞Ä (Í≤åÏä§Ìä∏Í∞Ä ÏïÑÎãê ÎïåÎßå)
          if (!isGuest)
            _buildMenuTile(
              icon: Icons.delete_forever_outlined,
              title: 'Í≥ÑÏ†ï Î∞è Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú',
              subtitle: 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÌï©ÎãàÎã§',
              onTap: () => _showDeleteAccountDialog(),
            ),
        ],
      ),
    );
  }

  Widget _buildMenuTile({
    required IconData icon,
    required String title,
    required String subtitle,
    required VoidCallback onTap,
  }) {
    return ListTile(
      contentPadding: EdgeInsets.zero,
      leading: Icon(
        icon,
        color: const Color(0xFF6366F1),
      ),
      title: Text(
        title,
        style: const TextStyle(
          fontWeight: FontWeight.w500,
          color: Color(0xFF1E293B),
        ),
      ),
      subtitle: Text(
        subtitle,
        style: const TextStyle(
          fontSize: 12,
          color: Color(0xFF64748B),
        ),
      ),
      trailing: const Icon(
        Icons.chevron_right,
        color: Color(0xFF64748B),
      ),
      onTap: onTap,
    );
  }

  Widget _buildAdminSection() {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.deepPurple.withOpacity(0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.deepPurple.withOpacity(0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Row(
            children: [
              Icon(
                Icons.admin_panel_settings,
                color: Colors.deepPurple,
                size: 20,
              ),
              SizedBox(width: 8),
              Text(
                'Í¥ÄÎ¶¨Ïûê Î©îÎâ¥',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: Colors.deepPurple,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          _buildMenuTile(
            icon: Icons.dashboard,
            title: 'Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú',
            subtitle: 'ÏÇ¨Ïö©Ïûê ÌÜµÍ≥Ñ Î∞è Î∂ÑÏÑù',
            onTap: () => context.push('/admin'),
          ),
        ],
      ),
    );
  }

  Widget _buildLogoutButton(AppLocalizations localizations) {
    return SizedBox(
      width: double.infinity,
      height: 48,
      child: OutlinedButton(
        onPressed: _handleLogout,
        style: OutlinedButton.styleFrom(
          side: const BorderSide(color: Color(0xFFEF4444)),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
        ),
        child: const Text(
          'Î°úÍ∑∏ÏïÑÏõÉ',
          style: TextStyle(
            color: Color(0xFFEF4444),
            fontWeight: FontWeight.w500,
          ),
        ),
      ),
    );
  }

  void _navigateToAuth() {
    Navigator.of(context).push(
      MaterialPageRoute(builder: (context) => const SimpleAuthScreen()),
    );
  }

  void _navigateToAppInfo() {
    Navigator.of(context).push(
      MaterialPageRoute(builder: (context) => const AppInfoScreen()),
    );
  }

  Future<void> _openPrivacyPolicy() async {
    const url = 'https://raw.githubusercontent.com/wjb127/ai-diary-flutter-app/main/docs/privacy_policy.txt';
    final Uri uri = Uri.parse(url);
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Í∞úÏù∏Ï†ïÎ≥¥Ï≤òÎ¶¨Î∞©Ïπ®ÏùÑ Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§.'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Future<void> _openTermsOfService() async {
    const url = 'https://raw.githubusercontent.com/wjb127/ai-diary-flutter-app/main/docs/terms_of_service.txt';
    final Uri uri = Uri.parse(url);
    if (!await launchUrl(uri, mode: LaunchMode.externalApplication)) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Ïù¥Ïö©ÏïΩÍ¥ÄÏùÑ Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§.'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  Future<void> _restorePurchases() async {
    // Î°úÎî© Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
    if (mounted) {
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => const AlertDialog(
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              CircularProgressIndicator(),
              SizedBox(height: 16),
              Text('Íµ¨Îß§ ÎÇ¥Ïó≠ÏùÑ Î≥µÏõêÌïòÍ≥† ÏûàÏäµÎãàÎã§...'),
            ],
          ),
        ),
      );
    }

    try {
      final success = await _subscriptionService.restorePurchases();
      
      if (mounted) {
        Navigator.of(context).pop(); // Î°úÎî© Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
        
        showDialog(
          context: context,
          builder: (context) => AlertDialog(
            title: Row(
              children: [
                Icon(
                  success ? Icons.check_circle : Icons.info,
                  color: success ? const Color(0xFF10B981) : const Color(0xFF64748B),
                ),
                const SizedBox(width: 8),
                Text(success ? 'Î≥µÏõê ÏôÑÎ£å' : 'Î≥µÏõê ÎÇ¥Ïó≠ ÏóÜÏùå'),
              ],
            ),
            content: Text(
              success 
                ? 'Íµ¨Îß§ ÎÇ¥Ïó≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.\nÌîÑÎ¶¨ÎØ∏ÏóÑ Í∏∞Îä•ÏùÑ Ïù¥Ïö©ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.' 
                : 'Î≥µÏõêÌï† Íµ¨Îß§ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.\nÏÉàÎ°ú Íµ¨ÎèÖÌïòÏãúÎ†§Î©¥ ÌîÑÎ¶¨ÎØ∏ÏóÑ Íµ¨ÎèÖ Î©îÎâ¥Î•º Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.',
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.of(context).pop(),
                child: const Text('ÌôïÏù∏'),
              ),
            ],
          ),
        );
      }
    } catch (e) {
      if (mounted) {
        Navigator.of(context).pop(); // Î°úÎî© Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
        
        showDialog(
          context: context,
          builder: (context) => AlertDialog(
            title: const Row(
              children: [
                Icon(Icons.error, color: Color(0xFFEF4444)),
                SizedBox(width: 8),
                Text('Î≥µÏõê Ïã§Ìå®'),
              ],
            ),
            content: const Text(
              'Íµ¨Îß§ ÎÇ¥Ïó≠ Î≥µÏõê Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\nÏû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.',
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.of(context).pop(),
                child: const Text('ÌôïÏù∏'),
              ),
            ],
          ),
        );
      }
    }
  }

  Future<void> _handleLogout() async {
    try {
      await _authService.signOut();
      // Î°úÍ∑∏ÏïÑÏõÉ ÌõÑ Í≤åÏä§Ìä∏ Î™®ÎìúÎ°ú Ï†ÑÌôò
      await _authService.signInAsGuest();
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Î°úÍ∑∏ÏïÑÏõÉÎêòÏóàÏäµÎãàÎã§. Í≤åÏä§Ìä∏ Î™®ÎìúÎ°ú Ï†ÑÌôòÎê©ÎãàÎã§.'),
            backgroundColor: Color(0xFF10B981),
          ),
        );
        setState(() {});
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Î°úÍ∑∏ÏïÑÏõÉ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'),
            backgroundColor: Color(0xFFEF4444),
          ),
        );
      }
    }
  }
  
  // Í≥ÑÏ†ï ÏÇ≠Ï†ú Îã§Ïù¥ÏñºÎ°úÍ∑∏
  Future<void> _showDeleteAccountDialog() async {
    final localizationService = Provider.of<LocalizationService>(context, listen: false);
    
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            const Icon(
              Icons.warning_amber_outlined,
              color: Color(0xFFEF4444),
              size: 24,
            ),
            const SizedBox(width: 8),
            Text(
              localizationService.isKorean ? 'Í≥ÑÏ†ï ÏÇ≠Ï†ú' : 'Delete Account',
              style: const TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: Color(0xFFEF4444),
              ),
            ),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              localizationService.isKorean 
                  ? 'Ï†ïÎßêÎ°ú Í≥ÑÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'
                  : 'Are you sure you want to delete your account?',
              style: const TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 12),
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: const Color(0xFFFEE2E2),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(
                  color: const Color(0xFFFCA5A5),
                  width: 1,
                ),
              ),
              child: Text(
                localizationService.isKorean
                    ? '‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!\n\n'
                      '‚Ä¢ Î™®Îì† ÏùºÍ∏∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎê©ÎãàÎã§\n'
                      '‚Ä¢ AIÎ°ú ÏÉùÏÑ±Îêú ÏΩòÌÖêÏ∏†Í∞Ä Î™®Îëê ÏÇ≠Ï†úÎê©ÎãàÎã§\n'
                      '‚Ä¢ Íµ¨ÎèÖ Ï†ïÎ≥¥Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§\n'
                      '‚Ä¢ Í≥ÑÏ†ïÏùÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§'
                    : '‚ö†Ô∏è This action cannot be undone!\n\n'
                      '‚Ä¢ All diaries will be permanently deleted\n'
                      '‚Ä¢ All AI-generated content will be deleted\n'
                      '‚Ä¢ Subscription info will be deleted\n'
                      '‚Ä¢ Account cannot be recovered',
                style: const TextStyle(
                  fontSize: 12,
                  color: Color(0xFF991B1B),
                  height: 1.5,
                ),
              ),
            ),
            const SizedBox(height: 16),
            Text(
              localizationService.isKorean
                  ? 'Í≥ÑÏÜçÌïòÎ†§Î©¥ "ÏÇ≠Ï†ú" Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:'
                  : 'Type "DELETE" to continue:',
              style: const TextStyle(
                fontSize: 13,
                fontWeight: FontWeight.w500,
              ),
            ),
            const SizedBox(height: 8),
            TextField(
              controller: _deleteConfirmController,
              decoration: InputDecoration(
                hintText: localizationService.isKorean ? 'ÏÇ≠Ï†ú' : 'DELETE',
                contentPadding: const EdgeInsets.symmetric(
                  horizontal: 12,
                  vertical: 8,
                ),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(8),
                  borderSide: const BorderSide(
                    color: Color(0xFFEF4444),
                    width: 2,
                  ),
                ),
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () {
              _deleteConfirmController.clear();
              Navigator.of(context).pop();
            },
            child: Text(
              localizationService.isKorean ? 'Ï∑®ÏÜå' : 'Cancel',
              style: const TextStyle(color: Color(0xFF64748B)),
            ),
          ),
          ElevatedButton(
            onPressed: () async {
              final confirmText = _deleteConfirmController.text;
              final expectedText = localizationService.isKorean ? 'ÏÇ≠Ï†ú' : 'DELETE';
              
              if (confirmText != expectedText) {
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      localizationService.isKorean 
                          ? 'ÌôïÏù∏ ÌÖçÏä§Ìä∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§'
                          : 'Confirmation text does not match',
                    ),
                    backgroundColor: Colors.orange,
                  ),
                );
                return;
              }
              
              _deleteConfirmController.clear();
              Navigator.of(context).pop();
              await _deleteAccount();
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFFEF4444),
            ),
            child: Text(
              localizationService.isKorean ? 'ÏòÅÍµ¨ ÏÇ≠Ï†ú' : 'Delete Forever',
              style: const TextStyle(color: Colors.white),
            ),
          ),
        ],
      ),
    );
  }
  
  // Í≥ÑÏ†ï ÏÇ≠Ï†ú Ïã§Ìñâ
  Future<void> _deleteAccount() async {
    final localizationService = Provider.of<LocalizationService>(context, listen: false);
    
    // Î°úÎî© Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÌëúÏãú
    if (mounted) {
      showDialog(
        context: context,
        barrierDismissible: false,
        builder: (context) => const AlertDialog(
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              CircularProgressIndicator(),
              SizedBox(height: 16),
              Text('Í≥ÑÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÍ≥† ÏûàÏäµÎãàÎã§...'),
            ],
          ),
        ),
      );
    }
    
    try {
      // TODO: Ïã§Ï†ú Í≥ÑÏ†ï ÏÇ≠Ï†ú API Ìò∏Ï∂ú
      // await _authService.deleteAccount();
      // await _diaryService.deleteAllDiaries();
      
      // ÏûÑÏãú: Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨
      await Future.delayed(const Duration(seconds: 2));
      await _authService.signOut();
      await _authService.signInAsGuest();
      
      if (mounted) {
        Navigator.of(context).pop(); // Î°úÎî© Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
        
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              localizationService.isKorean 
                  ? 'Í≥ÑÏ†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§'
                  : 'Account deleted successfully',
            ),
            backgroundColor: const Color(0xFF10B981),
          ),
        );
        
        // Ìôà ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
        context.go('/');
      }
    } catch (e) {
      if (mounted) {
        Navigator.of(context).pop(); // Î°úÎî© Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Í∏∞
        
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              localizationService.isKorean 
                  ? 'Í≥ÑÏ†ï ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§'
                  : 'Error deleting account',
            ),
            backgroundColor: const Color(0xFFEF4444),
          ),
        );
      }
    }
  }
  
  final TextEditingController _deleteConfirmController = TextEditingController();
}
